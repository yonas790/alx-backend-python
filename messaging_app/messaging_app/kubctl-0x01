#!/bin/bash

# kubctl-0x01
# Script to scale the Django app in Kubernetes and test performance

set -e

DEPLOYMENT_NAME="messaging-app-deployment"

echo "üì¶ Scaling Django app deployment to 3 replicas..."
kubectl scale deployment $DEPLOYMENT_NAME --replicas=3

echo "‚è≥ Waiting for pods to be ready..."
kubectl rollout status deployment/$DEPLOYMENT_NAME

echo "üìã Listing all running pods..."
kubectl get pods -o wide

echo "üìä Monitoring resource usage (press Ctrl+C to stop)..."
kubectl top pods || echo "‚ö†Ô∏è 'kubectl top' requires metrics-server to be installed."

echo "üöÄ Performing load testing with wrk..."
# Check if wrk is installed
if ! command -v wrk &> /dev/null; then
    echo "‚ö†Ô∏è wrk not found. Please install it:"
    echo "   sudo apt-get install wrk   # for Debian/Ubuntu"
    exit 1
fi

# NOTE: Replace <SERVICE-IP> with your actual service's ClusterIP or NodePort.
SERVICE_IP=$(kubectl get svc messaging-app-service -o jsonpath='{.spec.clusterIP}')
wrk -t4 -c50 -d30s http://$SERVICE_IP:8000/

echo "‚úÖ Scaling and testing complete."
