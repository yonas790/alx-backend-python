#!/bin/bash

# kubctl-0x03
# Script to perform a rolling update and monitor downtime

set -e

DEPLOYMENT_NAME="messaging-app-blue"
SERVICE_NAME="messaging-app-service"

echo "📦 Applying updated deployment (version 2.0)..."
kubectl apply -f blue_deployment.yaml

echo "🔄 Monitoring rolling update status..."
kubectl rollout status deployment/$DEPLOYMENT_NAME

echo "🔍 Finding service ClusterIP..."
SERVICE_IP=$(kubectl get svc $SERVICE_NAME -o jsonpath='{.spec.clusterIP}')

echo "🚀 Testing for downtime using curl..."
for i in {1..20}
do
    if curl -s --max-time 2 http://$SERVICE_IP:8000/ > /dev/null; then
        echo "[$i] ✅ Request successful"
    else
        echo "[$i] ❌ Request failed"
    fi
    sleep 1
done

echo "📋 Verifying updated pods..."
kubectl get pods -l app=messaging-app,version=blue -o wide

echo "✅ Rolling update completed successfully."
